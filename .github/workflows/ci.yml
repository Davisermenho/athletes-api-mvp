name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Map DATABASE_URL from repository secrets into the job environment.
# Do NOT print the value anywhere in the workflow.
env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  test:
    name: CI â€” format, DB-check, migrations and tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -r requirements-dev.txt
        # keep secret usage limited to env; pip output will not print the secret

      - name: Black format check
        run: black --check .

      - name: isort check
        run: isort --check-only .

      - name: DB connection check (safe)
        # This step attempts to connect using SQLAlchemy and prints only DB_CONN_OK or DB_CONN_FAIL.
        # It will not echo the DATABASE_URL value.
        run: |
          python - <<'PY'
          import os, sys
          try:
              url = os.environ.get('DATABASE_URL','')
              if not url:
                  print('DB_CONN_FAIL')
                  sys.exit(1)
              from sqlalchemy import create_engine
              engine = create_engine(url)
              conn = engine.connect()
              conn.close()
              print('DB_CONN_OK')
              sys.exit(0)
          except Exception:
              # Do not print exception details or the URL
              print('DB_CONN_FAIL')
              sys.exit(1)
          PY

      - name: Run alembic migrations (conditional)
        if: ${{ env.DATABASE_URL != '' }}
        run: |
          # Only run migrations when DATABASE_URL is provided by the secret.
          # Ensure this secret points to a disposable/test database when used in CI.
          alembic upgrade head
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run tests
        run: pytest -q --disable-warnings --maxfail=1
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
